<?php
/**
 * @file
 *
 * Different custom configs for Cinema Search site.
 */

/**
 * Implements hook_menu().
 */
function custom_menu() {
  return [
    'ajax/node/random' => [
      'page callback' => 'custom_ajax_random_node_callback',
      'page arguments' => [2],
      'type' => MENU_CALLBACK,
      'delivery callback' => 'custom_ajax_delivery_callback',
      'access callback' => TRUE,
    ],
  ];
}

/**
 * Ajax callback returns random node.
 */
function custom_ajax_random_node_callback() {
  $query = db_select('node', 'n')
    ->fields('n', ['nid'])
    ->orderRandom()
    ->execute()
    ->fetchObject();

  $node = node_load($query->nid);

  return node_view($node, 'teaser');
}

/**
 * Ajax delivery callback render content.
 *
 * @param $content
 */
function custom_ajax_delivery_callback($content) {
  print drupal_render($content);
  drupal_page_footer();
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function custom_form_views_exposed_form_alter(&$form, &$form_state) {
  // Set placeholders to exposed search block.
  $form['title']['#attributes'] = ['placeholder' => t('Title')];
  $form['field_year_single']['#attributes'] = ['placeholder' => t('Single year')];
  $form['field_year_range']['min']['#attributes'] = ['placeholder' => t('Min year')];
  $form['field_year_range']['max']['#attributes'] = ['placeholder' => t('Max year')];
}

/**
 * Implements hook_node_view_alter().
 */
function custom_node_view_alter(&$build) {
  if ($build['#entity_type'] == 'node' && $build['#bundle'] == 'film' && $build['#view_mode'] == 'teaser') {
    try {
      if (!isset($build['field_poster_image'])) {
        $build['field_poster_image'] = [
          '#type' => 'container',
          '#attributes' => [
            'class' => [
              'field-name-field-poster-image',
            ],
          ],
        ];
        $build['field_poster_image'][] = [
          '#markup' => theme('image', [
            'path' => drupal_get_path('theme', 'movies') . '/images/nopicture.gif',
          ]),
        ];
      }
    } catch (Exception $_) {
    }
  }
}
